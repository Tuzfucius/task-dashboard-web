<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ªªÂä°ÁúãÊùø V2 - Task Dashboard</title>
    <link href="/static/css/output.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gradient-to-br from-gray-100 via-gray-50 to-blue-50 dark:from-dark-900 dark:via-dark-800 dark:to-dark-900 min-h-screen" x-data="taskBoard()" x-init="initTheme(); init()">
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-purple-500/20 rounded-full blur-3xl"></div>
        <div class="absolute top-1/3 -left-40 w-80 h-80 bg-gradient-to-br from-green-400/20 to-cyan-500/20 rounded-full blur-3xl"></div>
    </div>

    <div x-show="isOffline" x-cloak class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-red-600 text-white text-center py-2.5 text-sm z-50">‚ö†Ô∏è ÁΩëÁªúËøûÊé•Êñ≠ÂºÄ</div>

    <header class="glass shadow-lg border-b border-gray-200/50 dark:border-dark-700/50 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white shadow-lg">üìã</div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800 dark:text-white">‰ªªÂä°ÁúãÊùø V2</h1>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Êô∫ËÉΩ‰Ωì‰ªªÂä°ÁÆ°ÁêÜ</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-white/60 dark:bg-dark-700/60 px-4 py-2 rounded-xl border">
                        <span class="text-xs text-gray-500 block">ÊÄª‰ªªÂä°</span>
                        <span class="text-lg font-bold" x-text="stats.total || 0"></span>
                    </div>
                    <div class="bg-blue-50/60 dark:bg-blue-900/30 px-4 py-2 rounded-xl border border-blue-200">
                        <span class="text-xs text-blue-500 block">ËøõË°å‰∏≠</span>
                        <span class="text-lg font-bold text-blue-600" x-text="stats.in_progress || 0"></span>
                    </div>
                    <div class="bg-green-50/60 dark:bg-green-900/30 px-4 py-2 rounded-xl border border-green-200">
                        <span class="text-xs text-green-500 block">Â∑≤ÂÆåÊàê</span>
                        <span class="text-lg font-bold text-green-600" x-text="stats.completed || 0"></span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="toggleTheme()" class="p-2 rounded-xl bg-gray-100 dark:bg-dark-700 hover:scale-105 transition" title="ÂàáÊç¢‰∏ªÈ¢ò">‚òÄÔ∏è/üåô</button>
                    <button @click="openArchive()" class="px-3 py-1.5 text-sm bg-amber-100 dark:bg-amber-900/40 text-amber-700 rounded-lg">üì¶ ÂΩíÊ°£</button>
                    <button @click="showNewTask = true" class="px-3 py-1.5 text-sm bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:opacity-90">‚ûï Êñ∞Âª∫</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <input type="text" x-model="searchQuery" @input="filterTasks()" placeholder="ÊêúÁ¥¢‰ªªÂä°..." class="flex-1 min-w-[200px] max-w-md px-4 py-2 bg-white dark:bg-dark-700 rounded-lg border-0 focus:ring-2 focus:ring-blue-500 dark:text-white">
                <div class="flex items-center gap-1 p-1 bg-white/50 dark:bg-dark-700/50 rounded-lg">
                    <button @click="selectedAgent = null; filterTasks()" class="px-3 py-1 text-xs rounded" :class="selectedAgent === null ? 'bg-gray-700 text-white' : 'text-gray-600 hover:bg-gray-100'">ÂÖ®ÈÉ®</button>
                    <template x-for="(color, agent) in agentColors" :key="agent">
                        <button @click="selectedAgent = agent; filterTasks()" class="px-2 py-1 text-xs rounded" :class="selectedAgent === agent ? 'bg-' + color + '-600 text-white' : 'text-' + color + '-600 hover:bg-' + color + '-50'" x-text="agent"></button>
                    </template>
                </div>
                <span x-show="isLoading" class="text-sm text-gray-500">‚ü≥ ÂêåÊ≠•‰∏≠...</span>
            </div>
        </div>
    </header>

    <main class="relative max-w-7xl mx-auto p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white/60 dark:bg-dark-800/60 backdrop-blur-sm rounded-2xl p-4 min-h-[500px] border border-gray-200/50 dark:border-dark-700/50" @dragover.prevent="dragOver = 'planned'" @dragleave="dragOver = null" @drop.prevent="onDrop('planned')" :class="dragOver === 'planned' ? 'ring-2 ring-blue-400/50' : ''">
                <h2 class="font-semibold text-gray-700 dark:text-gray-200 mb-4">üìã ËÆ°Âàí‰ªªÂä° (<span x-text="filteredPlanned.length"></span>)</h2>
                <div class="space-y-3">
                    <template x-for="task in filteredPlanned" :key="task.id">
                        <div :draggable="true" @dragstart="onDragStart($event, task)" @dragend="onDragEnd($event)" @click="openTaskDetail(task)" @contextmenu.prevent="showContextMenu($event, task)" class="bg-white/80 dark:bg-dark-700/80 rounded-xl shadow-sm border p-3 cursor-pointer hover:shadow-md" :class="'border-l-4 border-' + task.agent_color + '-400'">
                            <div class="flex items-start justify-between mb-2">
                                <span x-text="task.agent_icon"></span>
                                <span class="text-xs px-2 py-0.5 rounded" :class="'bg-' + task.agent_color + '-100 text-' + task.agent_color + '-700'" x-text="task.agent_name"></span>
                            </div>
                            <h3 class="font-medium text-sm text-gray-800 dark:text-gray-100" x-text="task.title"></h3>
                            <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                                <span x-text="task.updated_at"></span>
                                <span x-text="task.owner"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="filteredPlanned.length === 0" class="text-center py-12 text-gray-400">ÊöÇÊó†ËÆ°Âàí‰ªªÂä°</div>
                </div>
            </div>

            <div class="bg-white/60 dark:bg-dark-800/60 backdrop-blur-sm rounded-2xl p-4 min-h-[500px] border border-gray-200/50 dark:border-dark-700/50" @dragover.prevent="dragOver = 'in_progress'" @dragleave="dragOver = null" @drop.prevent="onDrop('in_progress')" :class="dragOver === 'in_progress' ? 'ring-2 ring-amber-400/50' : ''">
                <h2 class="font-semibold text-gray-700 dark:text-gray-200 mb-4">üîÑ ËøõË°å‰∏≠ (<span x-text="filteredInProgress.length"></span>)</h2>
                <div class="space-y-3">
                    <template x-for="task in filteredInProgress" :key="task.id">
                        <div :draggable="true" @dragstart="onDragStart($event, task)" @dragend="onDragEnd($event)" @click="openTaskDetail(task)" @contextmenu.prevent="showContextMenu($event, task)" class="bg-white/80 dark:bg-dark-700/80 rounded-xl shadow-sm border p-3 cursor-pointer hover:shadow-md" :class="'border-l-4 border-' + task.agent_color + '-400'">
                            <div class="flex items-start justify-between mb-2">
                                <span x-text="task.agent_icon"></span>
                                <span class="text-xs px-2 py-0.5 rounded" :class="'bg-' + task.agent_color + '-100 text-' + task.agent_color + '-700'" x-text="task.agent_name"></span>
                            </div>
                            <h3 class="font-medium text-sm text-gray-800 dark:text-gray-100" x-text="task.title"></h3>
                            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-1.5 mt-2">
                                <div class="h-1.5 rounded-full" :class="'bg-' + task.agent_color + '-500'" :style="'width: ' + task.progress_percent + '%'"></div>
                            </div>
                            <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                                <span x-text="task.progress"></span>
                                <span x-text="task.owner"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="filteredInProgress.length === 0" class="text-center py-12 text-gray-400">ÊöÇÊó†ËøõË°å‰∏≠‰ªªÂä°</div>
                </div>
            </div>

            <div class="bg-white/60 dark:bg-dark-800/60 backdrop-blur-sm rounded-2xl p-4 min-h-[500px] border border-gray-200/50 dark:border-dark-700/50" @dragover.prevent="dragOver = 'completed'" @dragleave="dragOver = null" @drop.prevent="onDrop('completed')" :class="dragOver === 'completed' ? 'ring-2 ring-green-400/50' : ''">
                <h2 class="font-semibold text-gray-700 dark:text-gray-200 mb-4">‚úÖ Â∑≤ÂÆåÊàê (<span x-text="filteredCompleted.length"></span>)</h2>
                <div class="space-y-3">
                    <template x-for="task in filteredCompleted" :key="task.id">
                        <div :draggable="true" @dragstart="onDragStart($event, task)" @dragend="onDragEnd($event)" @click="openTaskDetail(task)" @contextmenu.prevent="showContextMenu($event, task)" class="bg-white/80 dark:bg-dark-700/80 rounded-xl shadow-sm border p-3 cursor-pointer opacity-75" :class="'border-l-4 border-' + task.agent_color + '-400'">
                            <div class="flex items-start justify-between mb-2">
                                <span x-text="task.agent_icon"></span>
                                <span class="text-xs px-2 py-0.5 rounded" :class="'bg-' + task.agent_color + '-100 text-' + task.agent_color + '-700'" x-text="task.agent_name"></span>
                            </div>
                            <h3 class="font-medium text-sm text-gray-800 dark:text-gray-100" x-text="task.title"></h3>
                            <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                                <span x-text="task.updated_at"></span>
                                <span x-text="task.owner"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="filteredCompleted.length === 0" class="text-center py-12 text-gray-400">ÊöÇÊó†Â∑≤ÂÆåÊàê‰ªªÂä°</div>
                </div>
            </div>
        </div>
    </main>

    <div x-show="showDetail" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50" @click="showDetail = false"></div>
        <div class="relative bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
            <div class="px-6 py-4 border-b dark:border-dark-700 flex items-center justify-between" :class="'bg-' + (currentTask?.agent_color || 'blue') + '-50'">
                <div class="flex items-center gap-3">
                    <span class="text-2xl" x-text="currentTask?.agent_icon"></span>
                    <div>
                        <h2 class="font-semibold text-lg text-gray-800 dark:text-white" x-text="currentTask?.title"></h2>
                        <div class="text-sm text-gray-500 flex items-center gap-2">
                            <span x-text="currentTask?.agent_name"></span> ‚Ä¢ <span x-text="currentTask?.owner"></span> ‚Ä¢ <span x-text="currentTask?.created_at"></span>
                        </div>
                    </div>
                </div>
                <button @click="showDetail = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[50vh]">
                <div class="mb-4 p-4 bg-gray-50 dark:bg-dark-700 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium">ËøõÂ∫¶</span>
                        <span class="text-sm text-gray-600" x-text="currentTask?.progress + ' (' + currentTask?.progress_percent + '%)'"></span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                        <div class="h-2 rounded-full" :class="'bg-' + (currentTask?.agent_color || 'blue') + '-500'" :style="'width: ' + currentTask?.progress_percent + '%'"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <h3 class="text-sm font-medium mb-2">ÂΩìÂâç Phase</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded-lg" x-text="currentTask?.current_phase || 'Êú™ÂºÄÂßã'"></p>
                </div>
                <div x-show="currentTask?.blocker" class="mb-4">
                    <h3 class="text-sm font-medium text-red-600 mb-2">‚ö†Ô∏è ÈòªÂ°ûÁÇπ</h3>
                    <p class="text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 px-3 py-2 rounded-lg" x-text="currentTask?.blocker"></p>
                </div>
                <div x-show="currentTask?.execution_records?.length > 0" class="mb-4">
                    <h3 class="text-sm font-medium mb-2">üìù ÊâßË°åËÆ∞ÂΩï</h3>
                    <div class="space-y-2 max-h-32 overflow-y-auto">
                        <template x-for="record in currentTask?.execution_records" :key="record.time">
                            <div class="text-sm bg-gray-50 dark:bg-dark-700 px-3 py-2 rounded-lg">
                                <span class="text-gray-400" x-text="record.time"></span>
                                <span class="text-gray-600 dark:text-gray-400 ml-2" x-text="record.action"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t dark:border-dark-700 flex items-center justify-between bg-gray-50 dark:bg-dark-700/50">
                <div class="flex items-center gap-2">
                    <button @click="archiveTask(currentTask?.id)" class="px-3 py-1.5 text-sm bg-amber-100 dark:bg-amber-900/30 text-amber-700 rounded-lg">üì¶ ÂΩíÊ°£</button>
                    <button @click="deleteTask(currentTask?.id)" class="px-3 py-1.5 text-sm bg-red-100 dark:bg-red-900/30 text-red-700 rounded-lg">üóëÔ∏è Âà†Èô§</button>
                </div>
                <button @click="completeTask(currentTask?.id)" class="px-4 py-1.5 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600">‚úÖ Ê†áËÆ∞ÂÆåÊàê</button>
            </div>
        </div>
    </div>

    <div x-show="contextMenu.show" x-cloak class="fixed z-50 bg-white dark:bg-dark-700 rounded-xl shadow-xl border dark:border-dark-600 py-1.5 w-48" :style="'left: ' + contextMenu.x + 'px; top: ' + contextMenu.y + 'px'">
        <button @click="viewTaskDetail(); contextMenu.show = false" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-dark-600">üëÅÔ∏è Êü•ÁúãËØ¶ÊÉÖ</button>
        <button @click="completeTask(contextMenu.task?.id); contextMenu.show = false" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-dark-600">‚úÖ Ê†áËÆ∞ÂÆåÊàê</button>
        <button @click="archiveTask(contextMenu.task?.id); contextMenu.show = false" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-dark-600">üì¶ ÂΩíÊ°£</button>
        <hr class="my-1 border-gray-200 dark:border-dark-600">
        <button @click="deleteTask(contextMenu.task?.id); contextMenu.show = false" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">üóëÔ∏è Âà†Èô§</button>
    </div>
    <div x-show="contextMenu.show" @click="contextMenu.show = false" class="fixed inset-0 z-40"></div>

    <div x-show="showNewTask" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50" @click="showNewTask = false"></div>
        <div class="relative bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="px-6 py-4 border-b dark:border-dark-700 flex items-center justify-between bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-2xl">
                <h2 class="font-semibold text-lg text-white">‚ú® Êñ∞Âª∫‰ªªÂä°</h2>
                <button @click="showNewTask = false" class="text-white/80 hover:text-white">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‰ªªÂä°Ê†áÈ¢ò</label>
                    <input type="text" x-model="newTask.title" @keyup.enter="createTask()" placeholder="ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò..." class="w-full px-4 py-2 bg-white dark:bg-dark-700 border dark:border-dark-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ë¥üË¥£‰∫∫</label>
                    <input type="text" x-model="newTask.owner" placeholder="ËæìÂÖ•Ë¥üË¥£‰∫∫..." class="w-full px-4 py-2 bg-white dark:bg-dark-700 border dark:border-dark-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ÂàÜÈÖçÊô∫ËÉΩ‰Ωì</label>
                    <div class="grid grid-cols-5 gap-2">
                        <template x-for="(icon, name) in agentOptions" :key="name">
                            <button @click="newTask.agent = name" class="p-2 rounded-lg border-2 transition-all" :class="newTask.agent === name ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200' : 'border-gray-200 dark:border-dark-600 hover:border-gray-300'">
                                <span class="text-xl block text-center" x-text="icon"></span>
                                <span class="text-xs block text-center mt-1 text-gray-600 dark:text-gray-400" x-text="name"></span>
                            </button>
                        </template>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‰ºòÂÖàÁ∫ß</label>
                    <div class="flex gap-4">
                        <template x-for="p in priorityOptions" :key="p.value">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" x-model="newTask.priority" :value="p.value" class="w-4 h-4 text-blue-600">
                                <span class="text-sm" :class="'text-' + p.color + '-600'" x-text="p.label"></span>
                            </label>
                        </template>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ÊèèËø∞</label>
                    <textarea x-model="newTask.description" rows="3" placeholder="Ê∑ªÂä†‰ªªÂä°ÊèèËø∞..." class="w-full px-4 py-2 bg-white dark:bg-dark-700 border dark:border-dark-600 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none dark:text-white"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 border-t dark:border-dark-700 flex justify-end gap-3 bg-gray-50 dark:bg-dark-700/50 rounded-b-2xl">
                <button @click="showNewTask = false" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800">ÂèñÊ∂à</button>
                <button @click="createTask()" :disabled="!newTask.title.trim() || creatingTask" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50">
                    <span x-text="creatingTask ? 'ÂàõÂª∫‰∏≠...' : 'ÂàõÂª∫‰ªªÂä°'"></span>
                </button>
            </div>
        </div>
    </div>

    <div x-show="showArchive" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50" @click="showArchive = false"></div>
        <div class="relative bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[80vh]">
            <div class="px-6 py-4 border-b dark:border-dark-700 flex items-center justify-between bg-gradient-to-r from-amber-500 to-orange-600 rounded-t-2xl">
                <h2 class="font-semibold text-lg text-white">üì¶ ÂΩíÊ°£‰ªªÂä°</h2>
                <button @click="showArchive = false" class="text-white/80 hover:text-white">‚úï</button>
            </div>
            <div class="p-4 border-b">
                <input type="text" x-model="archiveSearch" placeholder="ÊêúÁ¥¢ÂΩíÊ°£‰ªªÂä°..." class="w-full px-4 py-2 bg-white dark:bg-dark-700 border dark:border-dark-600 rounded-lg focus:ring-2 focus:ring-amber-500 dark:text-white">
            </div>
            <div class="p-4 overflow-y-auto max-h-[60vh]">
                <div x-show="filteredArchived.length === 0" class="text-center py-12 text-gray-400">ÊöÇÊó†ÂΩíÊ°£‰ªªÂä°</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="task in filteredArchived" :key="task.id">
                        <div class="bg-gray-50 dark:bg-dark-700 rounded-lg p-4 border">
                            <div class="flex items-start justify-between mb-2">
                                <span x-text="task.agent_icon"></span>
                                <div class="flex gap-1">
                                    <button @click="restoreTask(task.id)" class="p-1 text-green-600 hover:bg-green-100 rounded" title="ÊÅ¢Â§ç">üîÑ</button>
                                    <button @click="deleteArchivedTask(task.id)" class="p-1 text-red-600 hover:bg-red-100 rounded" title="Âà†Èô§">üóëÔ∏è</button>
                                </div>
                            </div>
                            <h3 class="font-medium text-sm mb-2" x-text="task.title"></h3>
                            <div class="flex items-center gap-4 text-xs text-gray-500">
                                <span x-text="task.owner"></span>
                                <span>ÂΩíÊ°£‰∫é <span x-text="task.archived_at || 'Êú™Áü•'"></span></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script>
    function taskBoard() {
        return {
            isDark: localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches),
            initTheme() { if (this.isDark) document.documentElement.classList.add('dark'); },
            toggleTheme() {
                this.isDark = !this.isDark;
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
                if (this.isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            },
            tasks: [], planned: [], inProgress: [], completed: [], archivedTasks: [], stats: {},
            lastUpdate: '', isLoading: false, isOffline: false,
            searchQuery: '', selectedAgent: null, showDetail: false, currentTask: null,
            dragOver: null, draggedTask: null,
            contextMenu: { show: false, x: 0, y: 0, task: null },
            showNewTask: false, creatingTask: false,
            newTask: { title: '', owner: '', agent: 'ËÄÅ‰∏ë', priority: 'medium', description: '' },
            showArchive: false, archiveSearch: '',
            agentColors: { 'ËÄÅ‰∏ë': 'blue', 'ÈíÆÁ†Å': 'red', '‰∏ëÁâõ': 'green', 'Â≠êÈº†': 'yellow', 'ËàÜÊé¢': 'purple' },
            agentIcons: { 'ËÄÅ‰∏ë': 'üîµ', 'ÈíÆÁ†Å': 'üî¥', '‰∏ëÁâõ': 'üü¢', 'Â≠êÈº†': 'üü°', 'ËàÜÊé¢': 'üü£' },
            priorityOptions: [{ value: 'high', label: 'üî¥ È´ò', color: 'red' }, { value: 'medium', label: 'üü° ‰∏≠', color: 'yellow' }, { value: 'low', label: 'üü¢ ‰Ωé', color: 'green' }],
            agentOptions: { 'ËÄÅ‰∏ë': 'üîµ', 'ÈíÆÁ†Å': 'üî¥', '‰∏ëÁâõ': 'üü¢', 'Â≠êÈº†': 'üü°', 'ËàÜÊé¢': 'üü£' },
            filteredPlanned: [], filteredInProgress: [], filteredCompleted: [],
            
            init() {
                this.loadTasks();
                setInterval(() => this.loadTasks(), 5000);
            },
            
            async loadTasks() {
                try {
                    this.isLoading = true;
                    const res = await fetch('/api/tasks');
                    if (!res.ok) throw new Error('ÁΩëÁªúÈîôËØØ');
                    const data = await res.json();
                    this.tasks = [...data.planned, ...data.in_progress, ...data.completed];
                    this.planned = data.planned;
                    this.inProgress = data.in_progress;
                    this.completed = data.completed;
                    this.stats = data.stats;
                    this.filterTasks();
                } catch (e) {
                    console.error('Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•:', e);
                    this.isOffline = true;
                } finally {
                    this.isLoading = false;
                }
            },
            
            filterTasks() {
                const query = this.searchQuery.toLowerCase();
                const agent = this.selectedAgent;
                const filter = (tasks) => tasks.filter(t => {
                    const matchQuery = !query || t.title.toLowerCase().includes(query) || t.owner.toLowerCase().includes(query);
                    const matchAgent = !agent || t.agent_name === agent;
                    return matchQuery && matchAgent;
                });
                this.filteredPlanned = filter(this.planned);
                this.filteredInProgress = filter(this.inProgress);
                this.filteredCompleted = filter(this.completed);
            },
            
            openTaskDetail(task) {
                this.currentTask = task;
                this.showDetail = true;
            },
            
            showContextMenu(e, task) {
                this.contextMenu = { show: true, x: e.clientX, y: e.clientY, task: task };
            },
            
            viewTaskDetail() {
                if (this.contextMenu.task) this.openTaskDetail(this.contextMenu.task);
            },
            
            async deleteTask(taskId) {
                if (!taskId || !confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü')) return;
                try {
                    const res = await fetch('/api/tasks/' + taskId, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Âà†Èô§Â§±Ë¥•');
                    this.loadTasks();
                    this.showDetail = false;
                } catch (e) { alert('Âà†Èô§Â§±Ë¥•: ' + e.message); }
            },
            
            async archiveTask(taskId) {
                if (!taskId || !confirm('Á°ÆÂÆöË¶ÅÂΩíÊ°£Ëøô‰∏™‰ªªÂä°ÂêóÔºü')) return;
                try {
                    const res = await fetch('/api/tasks/archive/' + taskId, { method: 'POST' });
                    if (!res.ok) throw new Error('ÂΩíÊ°£Â§±Ë¥•');
                    this.loadTasks();
                    this.showDetail = false;
                } catch (e) { alert('ÂΩíÊ°£Â§±Ë¥•: ' + e.message); }
            },
            
            async completeTask(taskId) {
                if (!taskId) return;
                try {
                    const res = await fetch('/api/tasks/move/' + taskId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'completed', note: 'Ê†áËÆ∞‰∏∫Â∑≤ÂÆåÊàê' })
                    });
                    if (!res.ok) throw new Error('Êõ¥Êñ∞Â§±Ë¥•');
                    this.loadTasks();
                    this.showDetail = false;
                } catch (e) { alert('Êõ¥Êñ∞Â§±Ë¥•: ' + e.message); }
            },
            
            onDragStart(e, task) {
                this.draggedTask = task;
                e.dataTransfer.effectAllowed = 'move';
                e.target.classList.add('opacity-50');
            },
            
            onDragEnd(e) {
                e.target.classList.remove('opacity-50');
                this.draggedTask = null;
                this.dragOver = null;
            },
            
            async onDrop(status) {
                if (!this.draggedTask) return;
                try {
                    const res = await fetch('/api/tasks/move/' + this.draggedTask.id, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: status })
                    });
                    if (!res.ok) throw new Error('ÁßªÂä®Â§±Ë¥•');
                    this.loadTasks();
                } catch (e) { alert('ÁßªÂä®Â§±Ë¥•: ' + e.message); }
                this.draggedTask = null;
                this.dragOver = null;
            },
            
            async createTask() {
                if (!this.newTask.title.trim() || this.creatingTask) return;
                try {
                    this.creatingTask = true;
                    const res = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newTask)
                    });
                    if (!res.ok) throw new Error('ÂàõÂª∫Â§±Ë¥•');
                    this.showNewTask = false;
                    this.newTask = { title: '', owner: '', agent: 'ËÄÅ‰∏ë', priority: 'medium', description: '' };
                    this.loadTasks();
                } catch (e) { alert('ÂàõÂª∫Â§±Ë¥•: ' + e.message); }
                finally { this.creatingTask = false; }
            },
            
            async openArchive() {
                try {
                    const res = await fetch('/api/archive');
                    const data = await res.json();
                    this.archivedTasks = data.archived || [];
                    this.showArchive = true;
                } catch (e) { alert('Âä†ËΩΩÂΩíÊ°£Â§±Ë¥•: ' + e.message); }
            },
            
            async restoreTask(taskId) {
                try {
                    const res = await fetch('/api/archive/' + taskId, { method: 'POST' });
                    if (!res.ok) throw new Error('ÊÅ¢Â§çÂ§±Ë¥•');
                    this.openArchive();
                    this.loadTasks();
                } catch (e) { alert('ÊÅ¢Â§çÂ§±Ë¥•: ' + e.message); }
            },
            
            async deleteArchivedTask(taskId) {
                if (!confirm('Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü')) return;
                try {
                    const res = await fetch('/api/tasks/' + taskId, { method: 'DELETE' });
                    this.openArchive();
                } catch (e) { alert('Âà†Èô§Â§±Ë¥•: ' + e.message); }
            },
            
            get filteredArchived() {
                if (!this.archiveSearch) return this.archivedTasks;
                const query = this.archiveSearch.toLowerCase();
                return this.archivedTasks.filter(t => t.title.toLowerCase().includes(query) || t.owner.toLowerCase().includes(query));
            }
        };
    }
    </script>
</body>
</html>
